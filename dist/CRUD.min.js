!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function many(sets){var o={},l=sets.length-1,first=sets[0],last=sets[l];for(var i in first)o[first[i]]=0;for(var i=1;l>=i;i++){var row=sets[i];for(var j in row){var key=row[j];o[key]===i-1&&(o[key]=i)}}var a=[];for(var i in last){var key=last[i];o[key]===l&&a.push(key)}return a}function intersect(a,b){if(!b)return many(a);for(var res=[],i=0;i<a.length;i++)indexOf(b,a[i])>-1&&res.push(a[i]);return res}function indexOf(arr,el){for(var i=0;i<arr.length;i++)if(arr[i]===el)return i;return-1}module.exports=intersect,intersect.big=function(a,b){if(!b)return many(a);for(var ret=[],temp={},i=0;i<b.length;i++)temp[b[i]]=!0;for(var i=0;i<a.length;i++)temp[a[i]]&&ret.push(a[i]);return ret}},{}],2:[function(require,module,exports){"use strict";module.exports=function(x){return"object"==typeof x&&null!==x}},{}],3:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_intersect=require("intersect"),_intersect2=_interopRequireDefault(_intersect),_isObject=require("is-object"),_isObject2=_interopRequireDefault(_isObject),_storageJs=require("./storage.js"),_storageJs2=_interopRequireDefault(_storageJs),_StorageDriverJs=require("./StorageDriver.js"),_StorageDriverJs2=_interopRequireDefault(_StorageDriverJs),Database=function(){function Database(){var conf=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,Database),this.conf=Object.assign({name:"database",indexedKeys:[],uniqueKey:"id",verbose:!1,driver:new _StorageDriverJs2["default"]({name:conf.name||"database",storage:_storageJs2["default"]})},conf),this._initialize()}return _createClass(Database,[{key:"_initialize",value:function(){this.data=this._load(),this.id=Math.max.apply(Math,_toConsumableArray(this.data).concat([0]))}},{key:"find",value:function(){var _this=this,obj=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],keys={indexed:{},unindexed:{}};for(var property in obj){var stack=this.conf.indexedKeys.includes(property)?"indexed":"unindexed";keys[stack][property]=obj[property]}var results=Object.keys(keys.indexed).map(function(prop){return _this.conf.driver.getItem(prop+":"+keys.indexed[prop])}),collection=results.length?1===results.length?results:_intersect2["default"].apply(void 0,_toConsumableArray(results)):this.data;return collection.map(this.conf.driver.getItem,this.conf.driver).filter(function(entry){return Object.keys(keys.unindexed).every(function(key){return entry[key]===keys.unindexed[key]})})}},{key:"insert",value:function(arg){if(Array.isArray(arg))return arg.forEach(this.insert,this);if(!(0,_isObject2["default"])(arg))throw new Error("Canâ€™t insert "+arg+". Please insert object.");if(this.id++,this.data.includes(this.id))return this._log("Existing entry for "+this.id+". Aborting.");var entry=this._addUniqueKey(arg,this.id);return this.data.push(this.id),this.conf.driver.setItem(this.id,entry),this.conf.driver.setItem("__data",this.data.join(",")),this._buildIndex(entry),this.id}},{key:"update",value:function(id,obj){if(this.data.includes(id)){var entry=this._addUniqueKey(obj,id);return this._destroyIndex(id),this.conf.driver.setItem(id,obj),this._buildIndex(obj),entry}this._log("No entry found for "+id+".")}},{key:"delete",value:function(arg){return(0,_isObject2["default"])(arg)?this._findAndDelete(arg):this.data.includes(arg)?(this.data.splice(this.data.indexOf(arg),1),this.conf.driver.removeItem(arg),this.conf.driver.setItem("__data",this.data.join(",")),this._destroyIndex(arg),!this.data.includes(arg)):void this._log("No entry found for "+arg+".")}},{key:"count",value:function(){return this.data.length}},{key:"drop",value:function(){return this.data.forEach(this["delete"],this),this.conf.driver.removeItem("__data"),this.data.length=0,this.id=0,!this.data.length}},{key:"_addUniqueKey",value:function(obj,id){return Object.assign({},obj,_defineProperty({},this.conf.uniqueKey,id))}},{key:"_findAndDelete",value:function(obj){var _this2=this,length=this.data.length;return this.find(obj).forEach(function(entry){return _this2["delete"](entry[_this2.conf.uniqueKey])}),this.data.length<length}},{key:"_load",value:function(){var data=this.conf.driver.getItem("__data");return data?data.split(",").map(Number):[]}},{key:"_buildIndex",value:function(obj){for(var property in obj)if(this.conf.indexedKeys.includes(property)){var key=property+":"+obj[property],index=this.conf.driver.getItem(key),value=[obj[this.conf.uniqueKey]];index&&(index.push(obj[this.conf.uniqueKey]),value=index),this.conf.driver.setItem(key,value)}}},{key:"_destroyIndex",value:function(id){var item=this.conf.driver.getItem(id);if(item)for(var property in item)if(this.conf.indexedKeys.includes(property)){var key=property+":"+item[property],index=this.conf.driver.getItem(key);index&&(index.splice(index.indexOf(id),1),index.length?this.conf.driver.setItem(key,index):this.conf.driver.removeItem(key))}}},{key:"_log",value:function(message){this.conf.verbose&&console&&console.log(message)}}]),Database}();exports["default"]=Database,module.exports=exports["default"]},{"./StorageDriver.js":4,"./storage.js":5,intersect:1,"is-object":2}],4:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),StorageDriver=function(){function StorageDriver(){var conf=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(_classCallCheck(this,StorageDriver),this.conf=conf,"function"!=typeof this.conf.storage.getItem||"function"!=typeof this.conf.storage.removeItem||"function"!=typeof this.conf.storage.setItem)throw new Error("Given Storage doesn't have methods `getItem`, `setItem` and `removeItem`.")}return _createClass(StorageDriver,[{key:"setItem",value:function(key,value){return this.conf.storage.setItem(this.conf.name+":"+key,JSON.stringify(value))}},{key:"getItem",value:function(key){return JSON.parse(this.conf.storage.getItem(this.conf.name+":"+key))}},{key:"removeItem",value:function(key){return this.conf.storage.removeItem(this.conf.name+":"+key)}}]),StorageDriver}();exports["default"]=StorageDriver,module.exports=exports["default"]},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var data={};exports["default"]="undefined"!=typeof localStorage?localStorage:{getItem:function(key){return data[key]||null},setItem:function(key,value){return data[key]=value},removeItem:function(key){return delete data[key]}},module.exports=exports["default"]},{}]},{},[3]);
